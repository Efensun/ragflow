# ES与ParadeDB搜索引擎对比测试工具使用指南（真实embedding版）

## 概述

本工具集用于对比验证Elasticsearch（ES）和ParadeDB在相同查询条件下的搜索结果一致性，**现已支持真实embedding向量**，可以验证语义相关性！

## 🎯 新特性：真实embedding向量支持

- ✅ 支持多种embedding模型：RAGFlow内置模型、sentence-transformers、transformers
- ✅ 自动生成真实的语义向量，而非随机向量
- ✅ 可以验证搜索结果与查询的真实语义关联
- ✅ 支持语义相关查询测试（如"AI和深度学习"）

## 文件说明

### 核心脚本

1. **`simple_kb_setup.py`** - 知识库设置脚本（已升级）
   - 使用真实embedding模型生成向量
   - 支持多种模型回退策略
   - 生成20个包含技术内容的示例文档

2. **`quick_search_test.py`** - 快速测试脚本（已升级）
   - 支持纯文本搜索、纯向量搜索、混合搜索
   - 使用真实embedding进行语义搜索
   - 显示搜索结果重叠率

3. **`compare_search_engines.py`** - 详细对比分析脚本
   - 全面的搜索引擎对比分析
   - 支持多种权重配置测试
   - 生成详细的一致性报告

## 快速开始

### 1. 安装依赖

确保安装以下Python包（可选，用于真实embedding向量）：

```bash
# 推荐：sentence-transformers（最简单）
pip install sentence-transformers

# 或者：transformers + torch（更灵活）
pip install transformers torch

# 基础依赖（通常已安装）
pip install numpy
```

**注意**：如果不安装这些依赖，工具会自动使用模拟向量作为备选方案。

### 2. 创建测试数据

```bash
# 进入测试目录
cd sdk/python/test/test_doc_engine

# 创建知识库和测试数据（使用真实embedding）
python simple_kb_setup.py
```

这将：
- 自动初始化embedding模型
- 创建ES和ParadeDB索引
- 生成20个包含真实embedding向量的文档
- 生成`test_kb_config.py`配置文件

### 3. 运行快速测试

```bash
# 快速验证搜索功能
python quick_search_test.py
```

### 4. 运行详细对比

```bash
# 详细的搜索引擎对比分析
python compare_search_engines.py
```

## Embedding模型支持

### 优先级顺序

1. **RAGFlow内置模型**（优先）
   - 使用RAGFlow配置的embedding模型
   - 与生产环境保持一致

2. **sentence-transformers**（推荐）
   - 模型：`BAAI/bge-large-zh-v1.5`
   - 安装：`pip install sentence-transformers`

3. **transformers**（备选）
   - 模型：`BAAI/bge-large-zh-v1.5`
   - 安装：`pip install transformers torch`

4. **模拟向量**（兜底）
   - 基于文本hash生成确定性向量
   - 确保相同文本生成相同向量

### 模型配置

在`rag/settings.py`中配置：

```python
LLM_FACTORY = {
    "embedding_model": "BAAI/bge-large-zh-v1.5",
    # 其他配置...
}
```

## 测试内容

### 示例文档（20个）

包含以下技术领域的文档：
- 人工智能基础知识
- 机器学习算法详解
- 自然语言处理技术应用
- 数据科学与大数据分析
- 云计算服务平台
- 区块链技术原理与应用
- Zendesk客户服务解决方案
- RESTful API设计规范
- 数据库管理与优化
- 软件开发最佳实践

### 测试查询

#### 精确匹配查询
- "人工智能基础知识"
- "机器学习算法"
- "自然语言处理技术"
- "数据科学分析"
- "云计算平台"

#### 语义相关查询
- "AI和深度学习"
- "NLP和文本分析"
- "大数据处理"
- "分布式系统"
- "客户支持平台"

## 搜索模式

### 1. 纯文本搜索
- 使用BM25算法
- 字段权重：content_ltks^10, title_tks^8, content_with_weight^2

### 2. 纯向量搜索
- 使用真实embedding向量
- 余弦相似度计算

### 3. 混合搜索
- 结合文本搜索和向量搜索
- 支持不同权重配置（0.2, 0.3, 0.5, 0.7, 0.8）

## 评估指标

### 一致性指标
- **排名相关性**：Spearman相关系数
- **分数相关性**：Pearson相关系数
- **Top-K重叠率**：Top-1, Top-3, Top-5, Top-10
- **平均分数差异**：搜索分数的差异程度

### 一致性评级
- **优秀**：相关性 > 0.8，重叠率 > 70%
- **良好**：相关性 > 0.6，重叠率 > 50%
- **需要改进**：相关性 ≤ 0.6 或重叠率 ≤ 50%

## 配置文件

### 自动生成的配置

运行`simple_kb_setup.py`后会生成`test_kb_config.py`：

```python
# 自动生成的搜索对比测试配置（使用真实embedding向量）
INDEX_NAME = "ragflow_xxxxx"
KB_ID = "xxxxx-xxxx-xxxx-xxxx-xxxxx"
TENANT_ID = "xxxxx-xxxx-xxxx-xxxx-xxxxx"

TEST_CONFIG = {
    "index_name": "ragflow_xxxxx",
    "kb_ids": ["xxxxx-xxxx-xxxx-xxxx-xxxxx"],
    "test_queries": [
        "人工智能基础知识",
        "机器学习算法",
        # ... 更多查询
    ]
}
```

## 故障排除

### 常见问题

1. **embedding模型加载失败**
   ```bash
   # 推荐安装sentence-transformers
   pip install sentence-transformers
   
   # 或者安装transformers + torch
   pip install transformers torch
   ```

2. **内存不足**
   - 使用CPU版本的torch：`pip install torch --index-url https://download.pytorch.org/whl/cpu`
   - 减少测试文档数量

3. **网络问题**
   - 使用国内镜像：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple sentence-transformers`
   - 手动下载模型文件

4. **数据库连接失败**
   - 检查ES和ParadeDB配置
   - 确认服务正在运行

5. **模拟向量提示**
   - 如果看到"使用模拟向量"提示，说明embedding模型未安装
   - 安装任一embedding包即可使用真实向量：`pip install sentence-transformers`

### 日志调试

设置详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 性能优化

### 向量生成优化
- 批量生成embedding向量
- 缓存已生成的向量
- 使用GPU加速（如果可用）

### 搜索优化
- 调整向量索引参数
- 优化查询字段权重
- 使用合适的相似度阈值

## 扩展功能

### 自定义embedding模型

```python
class CustomEmbeddingModel:
    def encode(self, text, normalize_embeddings=True):
        # 自定义embedding逻辑
        pass
```

### 自定义测试数据

修改`simple_kb_setup.py`中的`sample_contents`：

```python
sample_contents = [
    {
        "title": "自定义标题",
        "content": "自定义内容...",
        "keywords": ["关键词1", "关键词2"]
    },
    # 更多自定义内容...
]
```

## 最佳实践

1. **使用真实数据**：尽量使用与生产环境相似的数据
2. **多样化查询**：测试不同类型和长度的查询
3. **权重调优**：根据业务需求调整文本和向量权重
4. **定期验证**：在系统更新后重新运行对比测试
5. **监控性能**：关注搜索响应时间和资源使用

## 技术细节

### ES与ParadeDB差异

1. **搜索算法**：ES使用Elasticsearch BM25，ParadeDB使用ParadeDB BM25
2. **向量索引**：ES使用KNN，ParadeDB使用HNSW
3. **字段映射**：ES支持动态字段，ParadeDB映射到固定字段
4. **分词处理**：ES使用query_string，ParadeDB使用rag_tokenizer

### 向量字段映射

- ES：直接使用`q_1024_vec`等动态字段名
- ParadeDB：映射到固定的`embedding`字段

### 权重处理

- ES：支持字段级别boost（如`field^10`）
- ParadeDB：通过分层搜索策略模拟权重效果

## 联系支持

如有问题或建议，请：
1. 检查日志输出
2. 查看故障排除部分
3. 提交issue或联系开发团队

---

**注意**：使用真实embedding向量可以更准确地验证语义搜索的一致性，但需要额外的计算资源和模型下载时间。 